# Morro-x9-AC-Waveform-Generator

The Morro x9 Waveform Generator is a general purpose function generator which can create square, sinusoid, and triangular waveforms at frequencies of 100 Hz, 200 Hz, 300 Hz, 400 Hz, and 500 Hz. The Morro x9 includes a user interface made of a SparkFun COM-14662 passive 3x4 keypad and a Newhaven Display 2 lines x 16 characters LCD display module. The datasheets of these devices can be found in the Appendix. The waveforms are created by sending an array of analog voltages corresponding to each waveform to a MCP4921 12-bit Voltage Output DAC. The waveform computation, device interfacing and initialization, and power are provided and controlled by an STM32L4A6-ZGT6U Microcontroller.

The keypad allows the user to control the Morro x9 output waveform which includes the following functionality: frequency generation from 100 Hz to 500 Hz, selection of each of the three waveforms, and adjustment of the duty cycle of the square wave from 10% to 90% with a default of 50%. When a waveform other than the square wave is selected, the duty cycle resets to 50%. A map of these key commands can be seen in Table 1. 
 
The LCD displays the output waveform type (i.e. SIN, SQU, TRI), the frequency of the output, the last key pressed, and the duty cycle of the square wave. If a waveform other than the square wave is being displayed, the duty cycle will be displayed as 50%.

The output must be viewed using an oscilloscope as there is no waveform display included in this system. The default output upon power up is a 3 Vpeak-to-peak square wave at 100 Hz. 

# Program Description
int main(void)
The program begins by declaring several #defines which are used in creating the waveform arrays. These macros define values like the lengths of the arrays, the integer which creates a 1.5V offset, the slopes of the triangle waveform, and the indexes of the square array to iterate through to produce the square wave with its nine separate duty cycles. The variables and arrays used in the program are also defined here. The waveform functions are also defined here. It should be mentioned that the voltages being written to the DAC in these functions behave such that a voltage of 300 = 3V, 20 = 0.2V and 1 = 0.01V due to the algorithm used to write to the DAC from the keypad. This scheme was used to prevent the use of floats in the DAC program. 

Sine_Waveform() fills an array of length 392 with the voltage values of a 3 V peak-to-peak 100 Hz sinusoid with a 1.5V DC offset. This function actually fills two periods of the sinusoid within the sineWaveform array in order to produce a 100 Hz sine wave at the sample frequency of the system. Each other waveform array is filled with only one period of the waveform values. 

Square_Waveform() fills an array of length 192 using a for loop with values to create a 3 V 100 Hz square wave with a 50% duty cycle. To achieve the different duty cycles, the for-loop has a variable condition called dutyCycle which is updated depending on the user input. The default value of dutyCycle is 98. While it would be expected that this value should be half of the length of the array, throughout the creation of all waveforms there were quirks discovered when writing to the DAC at the system sample frequency, and sometimes trial and error was required to produce the desired waveform as in this case. If the duty cycle is to be increased by 10%, a value of 19 (~10% of the length of the array) is added to the dutyCycle variable. If the duty cycle is to be decreased by 10%, 19 is subtracted from the dutyCycle variable. This process creates the square wave with the desired duty cycle. 

Sawtooth_Waveform() produces a sawtooth waveform, but due to the limited keys on the COM-16442 Keypad, its functionality is not utilized in this program. 

Triangle_Waveform fills an array of length 350 with the voltage values necessary to create a 3 V peak-to-peak 100 Hz triangle wave. This function illustrates best the concept that creating these waveforms is like plotting points on a graph. Essentially each voltage value in the array is a “point” on a graph of a single period of the waveform which is written to the DAC at each sample instance. The function here employs the basic formula for a triangle and writes these values to the DAC.

Then the program defines the three waveform states SINE_WAVE, SQUARE_WAVE, and TRIANGLE_WAVE, which are selected by the user’s keypress. The default state is SQUARE_WAVE and is the existing state at power up. 

The program then initializes the Keypad, LCD, and DAC peripherals in main.c. The initialization code for each is included in .c files separate from main. Within each respective header is an explanation of how each program operates. After the peripherals are initialized, the three functions that create the waveform voltage arrays are called in main.c. 

Then Initialize_LCD() is called to initialize the LCD and display the default 100 Hz Square wave information on the LCD. Further explanation of the code related to the LCD will be given in the LCD Code section below. An image of the default LCD output can be seen in Figure 5. 

while(1)
The program first calls Key_Press() which constantly checks the columns of the keypad for a high voltage, which indicates that a key has been pressed. For further explanation of this function and the other keypad functions, see Keypad.c in the appendix. If a key is pressed then the program enters the decision structure which handles the change in functionality dependent upon each key. 

The keys relating to duty cycle control will be explained first because these conditional branches are the most complex. They are also the only key presses that require debouncing because they require the capture of the single key press. If the ‘#’ key is pressed, the duty cycle is still below 90%, and the current state of the waveform is SQAURE_WAVE, then the dutyCycle variable is incremented by DUTY_CYCLE_10, the macro corresponding to the integer needed to add 10% to the duty cycle via the for-loop in Square_Waveform(). Then the dutyCount variable is incremented by one. dutyCount is a counter which is used to update the duty cycle on the LCD display. dutyCount is initialized at 0x35, the ASCII value for 5, because this value is written to the LCD in the position of the duty cycle display. This counter is incremented or decremented to achieve a range of 1-9 in hex depending on the current waveform and the hex value corresponding to the duty cycle is then written to the LCD in Square_Waveform(). If the ‘*’ key is pressed, the duty cycle is still above 10%, and the current state of the waveform is SQAURE_WAVE, then the dutyCycle variable is incremented by DUTY_CYCLE_10 and the dutyCount is decremented by one. In each case, the LCD display updated to display the new duty cycle value and the last key pressed. If the ‘0’ key is pressed, the duty cycle is reset to 50% by resetting dutyCycle and dutyCount to their initial values. 

Keys 1 through 5 control the frequency of the waveform. This is done by changing the step at which the voltageIndex in the TIM2_IRQ Handler steps through the original waveform arrays created in main. Further explanation of the IRQ Handler will be found in the IRQ Handler section below. The functions in main create 100 Hz waveforms, and in this case each sample is written to the DAC. To create a waveform of a higher frequency (100 Hz higher in fact), the voltageIndex can just step through this original array at different step values. This process can be seen in Figure 6. By changing the voltageIndex to 2, only every other value is written to the DAC which results in a waveform with a frequency twice as high. This logic is then carried up to a step of 5, at which the resolution of the waveforms begin to break down. So, keys 1 through 5 update the freqIndex to 1,2,3,4 or 5 and this value is then updated in the IRQ Handler to step through each array accordingly. This frequency update is done independently of each waveform, so updating the frequency and switching between waveforms will result in different waveforms with the same frequency. In each case, the new frequency value and the key pressed is written to the LCD. 

Keys 6-8 are used to select the waveforms. Key 6 selects the sine wave and changes the current state to SINE_WAVE and writes the updated waveform name and the key pressed to the LCD. Key 7 selects the triangle  wave and changes the current state to TRI_WAVE and writes the updated waveform name and the key pressed to the LCD. Key 8 selects the sine wave and changes the current state to SQUARE_WAVE and writes the updated waveform name and the key pressed to the LCD. 

Key 9 is used to reset the system to its default state. Thus, dutyCount is reset to DUTY_COUNT_50, dutyCycle is reset to DUTY_CYCLE_50, and the current state is updated to SQUARE_WAVE. As always, the LCD is updated to display the frequency, waveform name, duty cycle of the waveform, and last key pressed. 

TIM2_IRQHandler
This is where the waveforms are written to the DAC to be output by the DAC itself. A static int variable called voltageIndex is initialized to 0 and this index is iterated through each waveform array to control which voltage value is being output. If the Update Interrupt Flag (UIF) is set in the TIM2 Status Register (SR), then the program outputs the voltage values for the selected waveform. This is done via a Switch/Case statement. The switch is dependent upon currentState which is selected by the user's key press and a case for each waveform is declared. For each waveform case, the counter iterates through the waveform array in steps determined by the frecIndex variable until it reaches the end of the array, after which the voltageIndex is reset to 0 and the process begins again. At each index, the voltage value of the array is written to the DAC via the DAC_Write() function. After each index is written, the UIF flag is reset and set again at the next sample time. The sample frequency calculations were already described in the Specifications section, but for further elucidation, each voltage level is written to the DAC when the ARR count reaches 204, which results in a set UIF and the voltage at the current voltageIndex being output at the calculated sample frequency. 




LCD Display
The LCD is a 2 row x 16 column character LCD display with addresses corresponding to each character in the 2x16 array. LCD.c has #define macros corresponding to pertinent address locations to easily write new values to the LCD. After the LCD is initialized with the default code, the only parts of the display that are updated are the 3 characters relating to the waveform name (SQU, SIN, and TRI), the first digit in the duty cycle value (i.e. the 5 in “50”), and the key  corresponding to the last key press. These macros are called using the Write_Command() function to shift the LCD to the proper address for writing. For example, to update the last key press, Write_Command(SHIFT_LAST_KEY) is called to move to the proper LCD character after which String_Write(“x”) is called with the appropriate digit in place of x. Defining these macros made for a simple process to update the LCD.

